#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import os
import zipfile
import sys
from datetime import datetime

def create_addon_zip():
    if not os.path.exists('manifest.json'):
        print("Error: manifest.json not found in current directory")
        sys.exit(1)

    try:
        with open('manifest.json', 'r') as f:
            manifest = json.load(f)

        extension_name = manifest.get('name', 'extension')
        extension_version = manifest.get('version', '0.0')

        filename = f"{extension_name.lower().replace(' ', '-')}-{extension_version}.zip"

        all_files = os.listdir('.')

        with zipfile.ZipFile(filename, 'w', zipfile.ZIP_DEFLATED) as zipf:
            files_to_add = [ 'manifest.json' ]

            if 'background' in manifest and 'scripts' in manifest['background']:
                files_to_add.extend(manifest['background']['scripts'])

            if 'browser_action' in manifest:
                if 'default_popup' in manifest['browser_action']:
                    files_to_add.append(manifest['browser_action']['default_popup'])
                if 'default_icon' in manifest['browser_action']:
                    files_to_add.append(manifest['browser_action']['default_icon'])

            if 'icons' in manifest:
                for icon in manifest['icons'].values():
                    files_to_add.append(icon)

            for file in all_files:
                ext = os.path.splitext(file)[1].lower()
                if ext in ['.html', '.js', '.css', '.svg', '.png', '.jpg', '.jpeg', '.gif']:
                    files_to_add.append(file)

            files_to_add = list(set(files_to_add))
            for file in files_to_add:
                if os.path.exists(file) and file != filename:
                    print(f"Adding: {file}")
                    zipf.write(file)
                else:
                    if file != filename:
                        print(f"Warning: File mentioned in manifest but not found: {file}")

        print(f"\nArchive created: {filename}")
        print(f"Files included: {len(files_to_add)}")
        return filename

    except json.JSONDecodeError:
        print("Error: manifest.json is not a valid JSON file")
        sys.exit(1)
    except Exception as e:
        print(f"Error: {str(e)}")
        sys.exit(1)


if __name__ == "__main__":
    print("Building Firefox extension ZIP archive...")
    zip_file = create_addon_zip()
    print(f"Build completed successfully: {zip_file}")
